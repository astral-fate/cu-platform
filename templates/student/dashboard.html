{% extends "student_layout.html" %}

{% block page_title %}لوحة التحكم{% endblock %}

{% block extra_css %}
<style>
    /* ==================================================================
      Dashboard Redesign (v3.0) - Final Fix
      ==================================================================
      Scoped all styles to a unique wrapper (.dashboard-content-area)
      to create a self-contained component and prevent any conflicts
      from parent templates or global stylesheets. This ensures
      predictable styling and correct text colors.
    */

    :root {
        --primary-color: #4f46e5;
        --primary-hover: #4338ca;
        --bg-color: #f3f4f6; /* Light gray page background */
        --card-bg-color: #ffffff;
        --card-border-color: #e5e7eb;
        --text-primary: #111827; /* Near black for headings and main text */
        --text-secondary: #6b7280; /* Gray for labels/muted text */
        --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -2px rgba(0, 0, 0, 0.05);
        --card-shadow-hover: 0 10px 15px -3px rgba(0, 0, 0, 0.07), 0 4px 6px -4px rgba(0, 0, 0, 0.07);
        --border-radius: 12px;
    }

    /* Main content wrapper */
    .dashboard-content-area {
        padding: 1.5rem;
        background-color: var(--bg-color);
    }

    /* Welcome Header Bar */
    .dashboard-content-area .welcome-header {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-hover) 100%);
        color: #fff;
        border-radius: var(--border-radius);
        padding: 1.5rem 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 10px 20px rgba(79, 70, 229, 0.2);
    }

    .dashboard-content-area .welcome-header h3 {
        font-size: 1.75rem;
        font-weight: 700;
        margin: 0;
        color: #fff; /* Explicitly set color */
    }

    /* Responsive Grid for Cards */
    .dashboard-content-area .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 1.5rem;
    }

    /* Enhanced Card Styling */
    .dashboard-content-area .card {
        background-color: var(--card-bg-color);
        border-radius: var(--border-radius);
        border: 1px solid var(--card-border-color);
        box-shadow: var(--card-shadow);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        display: flex;
        flex-direction: column;
    }

    .dashboard-content-area .card:hover {
        transform: translateY(-5px);
        box-shadow: var(--card-shadow-hover);
    }

    .dashboard-content-area .card-header {
        background-color: transparent;
        border-bottom: 1px solid var(--card-border-color);
        padding: 1.25rem 1.5rem;
    }

    .dashboard-content-area .card-header h3 {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--text-primary);
        margin: 0;
    }

    .dashboard-content-area .card-body {
        padding: 1.5rem;
        flex-grow: 1;
        display: flex;
        flex-direction: column;
    }

    /* Info Rows within cards */
    .dashboard-content-area .info-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.85rem 0;
        border-bottom: 1px solid #f3f4f6; /* Lighter separator */
    }
    .dashboard-content-area .info-row:first-of-type { padding-top: 0; }
    .dashboard-content-area .info-row:last-of-type { border-bottom: none; }

    /* Card-specific text colors, now properly scoped */
    .dashboard-content-area .info-label { color: var(--text-secondary); font-size: 0.9rem; }
    .dashboard-content-area .info-value, 
    .dashboard-content-area .document-item > span:first-child, 
    .dashboard-content-area .ticket-subject {
        font-weight: 500;
        color: var(--text-primary);
        font-size: 0.9rem;
    }

    /* List styling for 'Documents' & 'Tickets' */
    .dashboard-content-area .document-list, .dashboard-content-area .ticket-list {
        margin: 0;
        padding: 0;
        list-style-type: none;
        flex-grow: 1;
    }

    .dashboard-content-area .document-item, .dashboard-content-area .ticket-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 0.25rem;
        border-bottom: 1px solid #f3f4f6;
    }
    .dashboard-content-area .document-item:last-child, .dashboard-content-area .ticket-item:last-child { border-bottom: none; }
    .dashboard-content-area .ticket-details { text-align: right; }
    .dashboard-content-area .ticket-date { font-size: 0.8rem; color: var(--text-secondary); margin-top: 0.25rem; }

    /* Empty State Styling */
    .dashboard-content-area .empty-state {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
        flex-grow: 1;
        padding: 1rem 0;
    }
    .dashboard-content-area .empty-state p { color: var(--text-secondary); margin-bottom: 1.25rem; }

    /* Status Badge General Style */
    .dashboard-content-area .status-badge {
        padding: 0.3rem 0.85rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: capitalize;
    }
    .dashboard-content-area .status-badge.yellow { background-color: #fef9c3; color: #713f12; }
    .dashboard-content-area .status-badge.green { background-color: #dcfce7; color: #166534; }
    .dashboard-content-area .status-badge.red { background-color: #fee2e2; color: #991b1b; }
    .dashboard-content-area .status-badge.blue { background-color: #dbeafe; color: #1e40af; }

    /* Button Styles */
    .dashboard-content-area .btn.primary {
        display: inline-block;
        text-align: center;
        background-color: var(--primary-color);
        color: #fff !important; /* Ensure button text is white */
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        font-weight: 600;
        text-decoration: none;
        transition: background-color 0.2s ease, transform 0.2s ease;
        cursor: pointer;
    }
    .dashboard-content-area .btn.primary:hover {
        background-color: var(--primary-hover);
        transform: translateY(-2px);
    }
    .dashboard-content-area .btn.primary.full-width {
        display: block;
        width: 100%;
        margin-top: auto; /* Push button to the bottom of the card */
    }
</style>
{% endblock %}

{% block main_content %}
<!-- This new wrapper isolates the dashboard styles -->
<div class="dashboard-content-area">

    <div class="welcome-header">
        <h3>مرحباً، {{ current_user.full_name }}!</h3>
    </div>
    
    <!-- Alerts are now outside the grid -->
    {% if payment_required %}
    <div class="alert warning">
        <i class="fas fa-exclamation-triangle"></i>
        <div>
            <h4>الدفع مطلوب</h4>
            <p>تمت الموافقة على طلبك! يرجى متابعة الدفع لإكمال التسجيل.</p>
            {% for application in applications if application.status == 'Documents Approved' and application.payment_status == 'Pending' %}
                {% if loop.first %}
                <a href="{{ url_for('student_payment', app_id=application.id) }}" class="btn primary">إكمال الدفع</a>
                {% endif %}
            {% endfor %}
        </div>
    </div>
    {% endif %}
    
    {% if certificate_ready %}
    <div class="alert success" id="certificate-notification">
        <i class="fas fa-check-circle"></i>
        <div>
            <h4>الشهادة جاهزة</h4>
            <p>شهادتك جاهزة للاستلام! يرجى زيارة مكتب الإدارة لاستلامها.</p>
        </div>
        <button class="close-alert" onclick="dismissCertificateNotification()">
            <i class="fas fa-times"></i>
        </button>
    </div>
    {% endif %}

    <div class="dashboard-grid">
        <!-- Application Status Card -->
        <div class="card">
            <div class="card-header">
                <h3>حالة الطلب</h3>
            </div>
            <div class="card-body">
                {% if applications %}
                    {% set latest_app = applications|sort(attribute='date_submitted', reverse=true)|first %}
                    <div style="flex-grow: 1;">
                        <div class="info-row">
                            <span class="info-label">البرنامج:</span>
                            <span class="info-value">{{ latest_app.program }}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">الحالة:</span>
                            <span class="status-badge {% if latest_app.status == 'Pending Review' %}yellow{% elif latest_app.status == 'Documents Approved' %}green{% elif latest_app.status == 'Documents Rejected' %}red{% endif %}">
                                {{ latest_app.status }}
                            </span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">الدفع:</span>
                            <span class="status-badge {% if latest_app.payment_status == 'Pending' %}yellow{% elif latest_app.payment_status == 'Paid' %}green{% endif %}">
                                {{ latest_app.payment_status }}
                            </span>
                        </div>
                    </div>
                    {% if latest_app.status == 'Documents Approved' and latest_app.payment_status == 'Pending' %}
                        <a href="{{ url_for('student_payment', app_id=latest_app.id) }}" class="btn primary full-width">الدفع الآن</a>
                    {% endif %}
                {% else %}
                    <div class="empty-state">
                        <p>لم يتم العثور على طلبات</p>
                        <a href="{{ url_for('student_new_application') }}" class="btn primary">تقديم طلب جديد</a>
                    </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Documents Card -->
        <div class="card">
            <div class="card-header">
                <h3>المستندات</h3>
            </div>
            <div class="card-body">
                {% if documents %}
                    {% set doc_names_map = { 'bachelor degree certificate': 'شهادة البكالوريوس', 'academic transcript': 'السجل الأكاديمي', 'transcript': 'السجل الأكاديمي', 'id card/passport': 'بطاقة الهوية/جواز السفر', 'id card': 'بطاقة الهوية', 'passport': 'جواز السفر', 'national id': 'بطاقة الرقم القومي', 'national_id': 'بطاقة الرقم القومي', 'military status': 'موقف التجنيد', 'cv': 'السيرة الذاتية', 'resume': 'السيرة الذاتية', 'personal photo': 'الصورة الشخصية', 'photo': 'الصورة الشخصية', 'proof of english proficiency': 'إثبات إجادة اللغة الإنجليزية', 'english proficiency test': 'إثبات إجادة اللغة الإنجليزية', 'recommendation': 'خطاب توصية', 'recommendation letter': 'خطاب توصية', 'bachelor_degree': 'شهادة البكالوريوس', 'شهادة البكالوريوس': 'شهادة البكالوريوس', 'السجل الأكاديمي': 'السجل الأكاديمي', 'بطاقة الهوية/جواز السفر': 'بطاقة الهوية/جواز السفر', 'السيرة الذاتية': 'السيرة الذاتية', 'الصورة الشخصية': 'الصورة الشخصية', 'خطاب التوصية': 'خطاب التوصية', 'شهادة إجادة اللغة الإنجليزية': 'شهادة إجادة اللغة الإنجليزية', 'مستندات أخرى': 'مستندات أخرى' } %}
                    {% set status_map = { 'Uploaded': 'تم الرفع', 'Verified': 'مقبول', 'Rejected': 'مرفوض', 'تم الرفع': 'تم الرفع', 'مقبول': 'مقبول', 'مرفوض': 'مرفوض' } %}
                    <ul class="document-list">
                        {% for document in documents|sort(attribute='uploaded_at', reverse=true)|slice(0, 4) %}
                            <li class="document-item">
                                <span>{{ doc_names_map.get(document.name|lower, document.name) }}</span>
                                <span class="status-badge {% if document.status in ['Uploaded', 'تم الرفع'] %}blue{% elif document.status in ['Verified', 'مقبول'] %}green{% elif document.status in ['Rejected', 'مرفوض'] %}red{% endif %}">
                                    {{ status_map.get(document.status, document.status) }}
                                </span>
                            </li>
                        {% endfor %}
                    </ul>
                    <a href="{{ url_for('student_upload_document') }}" class="btn primary full-width">رفع مستند جديد</a>
                {% else %}
                    <div class="empty-state">
                        <p>لم يتم العثور على مستندات</p>
                        <a href="{{ url_for('student_upload_document') }}" class="btn primary">رفع مستند</a>
                    </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Support Tickets Card -->
        <div class="card">
            <div class="card-header">
                <h3>تذاكر الدعم الفني</h3>
            </div>
            <div class="card-body">
                {% if tickets %}
                    <ul class="ticket-list">
                        {% for ticket in tickets|sort(attribute='created_at', reverse=true)|slice(0, 4) %}
                            <li class="ticket-item">
                                <div class="ticket-details">
                                    <p class="ticket-subject">{{ ticket.subject }}</p>
                                    <p class="ticket-date">{{ ticket.created_at.strftime('%Y-%m-%d') }}</p>
                                </div>
                                <span class="status-badge {% if ticket.status == 'Open' %}red{% elif ticket.status == 'In Progress' %}yellow{% elif ticket.status == 'Closed' %}green{% endif %}">
                                    {{ ticket.status }}
                                </span>
                            </li>
                        {% endfor %}
                    </ul>
                    <a href="{{ url_for('student_new_ticket') }}" class="btn primary full-width">إنشاء تذكرة دعم جديدة</a>
                {% else %}
                    <div class="empty-state">
                        <p>لا توجد تذاكر دعم</p>
                        <a href="{{ url_for('student_new_ticket') }}" class="btn primary">إنشاء تذكرة</a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<!-- Include shared notification scripts -->
<script src="{{ url_for('static', filename='js/dashboard-notifications.js') }}"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Certificate notification dismissal
        const certificateNotification = document.getElementById('certificate-notification');
        if (certificateNotification) {
            if (localStorage.getItem('certificateDismissed') === 'true') {
                certificateNotification.style.display = 'none';
            }
        }
    });

    // Function to dismiss certificate notification
    function dismissCertificateNotification() {
        const notification = document.getElementById('certificate-notification');
        if (notification) {
            notification.style.display = 'none';
            localStorage.setItem('certificateDismissed', 'true');
        }
    }
</script>
{% endblock %}
