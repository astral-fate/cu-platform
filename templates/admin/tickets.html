{% extends "admin_layout.html" %}

{% block page_title %}تذاكر الدعم{% endblock %}

{% block main_content %}
<div class="card">
    <div class="card-header-with-actions">
        <h3>إدارة تذاكر الدعم</h3>
        <div class="header-actions">
            <div class="search-container">
                <input type="text" id="search-input" placeholder="ابحث في التذاكر..." class="form-input">
            </div>
            <select id="status-filter" class="form-input">
                <option value="">كل الحالات</option>
                <option value="Open">مفتوحة</option>
                <option value="In Progress">قيد المعالجة</option>
                <option value="Closed">مغلقة</option>
            </select>
        </div>
    </div>
    
    <div class="table-container">
        <table class="full-width-table">
            <thead>
                <tr>
                    <th>رقم التذكرة</th>
                    <th>الطالب</th>
                    <th>الموضوع</th>
                    <th>تاريخ الإنشاء</th>
                    <th>آخر تحديث</th>
                    <th>الحالة</th>
                    <th>الإجراءات</th>
                </tr>
            </thead>
            <tbody>
                {% for ticket in tickets %}
                    <tr>
                        <td>{{ ticket.ticket_id }}</td>
                        <td>{{ ticket.user.full_name }}</td>
                        <td>{{ ticket.subject }}</td>
                        <td>{{ ticket.created_at.strftime('%Y-%m-%d') }}</td>
                        <td>
                            {% if ticket.messages %}
                                {{ ticket.messages[-1].created_at.strftime('%Y-%m-%d') }}
                            {% else %}
                                {{ ticket.created_at.strftime('%Y-%m-%d') }}
                            {% endif %}
                        </td>
                        <td>
                            <span class="status-badge 
                                {% if ticket.status == 'Open' %}red
                                {% elif ticket.status == 'In Progress' %}yellow
                                {% elif ticket.status == 'Closed' %}green
                                {% endif %}">
                                {% if ticket.status == 'Open' %}مفتوحة
                                {% elif ticket.status == 'In Progress' %}قيد المعالجة
                                {% elif ticket.status == 'Closed' %}مغلقة
                                {% else %}{{ ticket.status }}
                                {% endif %}
                            </span>
                        </td>
                        <td>
                            <div class="actions-cell">
                                <a href="{{ url_for('admin_ticket_detail', ticket_id=ticket.id) }}" class="action-btn">
                                    <i class="fas fa-eye"></i> عرض
                                </a>
                                <select class="ticket-status-select" data-id="{{ ticket.id }}">
                                    <option value="Open" {% if ticket.status == 'Open' %}selected{% endif %}>مفتوحة</option>
                                    <option value="In Progress" {% if ticket.status == 'In Progress' %}selected{% endif %}>قيد المعالجة</option>
                                    <option value="Closed" {% if ticket.status == 'Closed' %}selected{% endif %}>مغلقة</option>
                                </select>
                            </div>
                        </td>
                    </tr>
                {% else %}
                    <tr>
                        <td colspan="7" class="text-center">لا توجد تذاكر دعم</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Analytics Section -->
<div class="card mt-6">
    <div class="card-header">
        <h3>تحليلات التذاكر</h3>
    </div>
    
    <div class="card-body">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-content rtl-stat">
                    <div class="stat-icon red">
                        <i class="fas fa-exclamation-circle"></i>
                    </div>
                    <div>
                        <h3 class="stat-title">التذاكر المفتوحة</h3>
                        <p class="stat-value">{{ tickets|selectattr('status', 'equalto', 'Open')|list|length }}</p>
                    </div>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-content rtl-stat">
                    <div class="stat-icon yellow">
                        <i class="fas fa-spinner"></i>
                    </div>
                    <div>
                        <h3 class="stat-title">قيد المعالجة</h3>
                        <p class="stat-value">{{ tickets|selectattr('status', 'equalto', 'In Progress')|list|length }}</p>
                    </div>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-content rtl-stat">
                    <div class="stat-icon green">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div>
                        <h3 class="stat-title">التذاكر المغلقة</h3>
                        <p class="stat-value">{{ tickets|selectattr('status', 'equalto', 'Closed')|list|length }}</p>
                    </div>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-content rtl-stat">
                    <div class="stat-icon blue">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div>
                        <h3 class="stat-title">متوسط وقت الاستجابة</h3>
                        <p class="stat-value">6.2 ساعة</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="mt-6">
            <h4 class="mb-4">المشاكل الشائعة</h4>
            <div class="table-container">
                <table class="full-width-table">
                    <thead>
                        <tr>
                            <th>فئة المشكلة</th>
                            <th>العدد</th>
                            <th>النسبة المئوية</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>مشاكل رفع المستندات</td>
                            <td>12</td>
                            <td>35%</td>
                        </tr>
                        <tr>
                            <td>مشاكل الدفع</td>
                            <td>8</td>
                            <td>23%</td>
                        </tr>
                        <tr>
                            <td>استفسارات عن حالة الطلب</td>
                            <td>7</td>
                            <td>20%</td>
                        </tr>
                        <tr>
                            <td>طلبات الشهادات</td>
                            <td>5</td>
                            <td>14%</td>
                        </tr>
                        <tr>
                            <td>أخرى</td>
                            <td>3</td>
                            <td>8%</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    // Search functionality
    document.getElementById('search-input').addEventListener('keyup', function() {
        const searchValue = this.value.toLowerCase();
        const rows = document.querySelectorAll('tbody tr');
        
        rows.forEach(row => {
            const ticketId = row.querySelector('td:nth-child(1)').textContent.toLowerCase();
            const student = row.querySelector('td:nth-child(2)').textContent.toLowerCase();
            const subject = row.querySelector('td:nth-child(3)').textContent.toLowerCase();
            
            if (ticketId.includes(searchValue) || 
                student.includes(searchValue) || 
                subject.includes(searchValue)) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    });
    
    // Status filter
    document.getElementById('status-filter').addEventListener('change', function() {
        const filterValue = this.value;
        const rows = document.querySelectorAll('tbody tr');
        
        rows.forEach(row => {
            if (!filterValue) {
                row.style.display = '';
                return;
            }
            
            const statusCell = row.querySelector('td:nth-child(6)');
            if (statusCell) {
                const statusBadge = statusCell.querySelector('.status-badge');
                const statusText = statusBadge ? statusBadge.textContent.trim() : '';
                
                // Map filter value to Arabic status text for comparison
                let filterText = filterValue;
                if (filterValue === 'Open') filterText = 'مفتوحة';
                else if (filterValue === 'In Progress') filterText = 'قيد المعالجة';
                else if (filterValue === 'Closed') filterText = 'مغلقة';

                if (statusText === filterText) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            }
        });
    });
    
    // Update ticket status
    const ticketStatusSelects = document.querySelectorAll('.ticket-status-select');
    
    ticketStatusSelects.forEach(select => {
        select.addEventListener('change', function() {
            const ticketId = this.getAttribute('data-id');
            const newStatus = this.value;
            const row = this.closest('tr');
            
            const formData = new FormData();
            formData.append('status', newStatus);
            
            fetch(`/admin/tickets/update_status/${ticketId}`, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update status badge
                    const statusCell = row.querySelector('td:nth-child(6)');
                    
                    let statusClass = '';
                    let statusText = newStatus; // Default to English value
                    switch(newStatus) {
                        case 'Open':
                            statusClass = 'red';
                            statusText = 'مفتوحة';
                            break;
                        case 'In Progress':
                            statusClass = 'yellow';
                            statusText = 'قيد المعالجة';
                            break;
                        case 'Closed':
                            statusClass = 'green';
                            statusText = 'مغلقة';
                            break;
                    }
                    
                    statusCell.innerHTML = `<span class="status-badge ${statusClass}">${statusText}</span>`;
                    
                    // Update analytics (in a real app, you'd reload the page or update the counts dynamically)
                    
                    // Show success message
                    alert(`تم تحديث حالة التذكرة إلى ${statusText}`); // Translate alert message
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('حدث خطأ. يرجى المحاولة مرة أخرى.'); // Translate error message
            });
        });
    });
</script>
<style>
    .rtl-stat {
        display: flex;
        flex-direction: row;
        justify-content: flex-start;
        text-align: right;
    }
    
    .rtl-stat .stat-icon {
        margin-left: 16px;
        margin-right: 0;
    }
</style>
{% endblock %}