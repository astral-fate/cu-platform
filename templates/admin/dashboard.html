{% extends "admin_layout.html" %}

{% block page_title %}لوحة تحكم مسؤول الشؤون الطلابية{% endblock %}

{% block main_content %}
<div class="dashboard-main-content" style="padding: 2rem 0;">
    <!-- Stats cards row -->
    <div class="stats-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; margin-bottom: 2.5rem;">
        <div class="stat-card" style="background: #fff; border-radius: 1rem; box-shadow: 0 4px 16px rgba(80,80,120,0.07); padding: 2rem 1.5rem; display: flex; align-items: center; justify-content: space-between;">
            <div>
                <h3 class="stat-title" style="color: #6b7280; font-size: 1rem; font-weight: 500;">التقديمات الجديدة</h3>
                <p class="stat-value" style="font-size: 2.2rem; font-weight: bold; color: #312e81; margin-top: 0.5rem;">{{ applications_count }}</p>
            </div>
            <div class="stat-icon blue" style="background: #dbeafe; color: #2563eb; width: 3.5rem; height: 3.5rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.7rem;">
                <i class="fas fa-file-alt"></i>
            </div>
        </div>
        <div class="stat-card" style="background: #fff; border-radius: 1rem; box-shadow: 0 4px 16px rgba(80,80,120,0.07); padding: 2rem 1.5rem; display: flex; align-items: center; justify-content: space-between;">
            <div>
                <h3 class="stat-title" style="color: #6b7280; font-size: 1rem; font-weight: 500;">المدفوعات المعلقة</h3>
                <p class="stat-value" style="font-size: 2.2rem; font-weight: bold; color: #312e81; margin-top: 0.5rem;">{{ payment_pending_count }}</p>
            </div>
            <div class="stat-icon yellow" style="background: #fef3c7; color: #d97706; width: 3.5rem; height: 3.5rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.7rem;">
                <i class="fas fa-dollar-sign"></i>
            </div>
        </div>
        <div class="stat-card" style="background: #fff; border-radius: 1rem; box-shadow: 0 4px 16px rgba(80,80,120,0.07); padding: 2rem 1.5rem; display: flex; align-items: center; justify-content: space-between;">
            <div>
                <h3 class="stat-title" style="color: #6b7280; font-size: 1rem; font-weight: 500;">التذاكر المفتوحة</h3>
                <p class="stat-value" style="font-size: 2.2rem; font-weight: bold; color: #312e81; margin-top: 0.5rem;">{{ open_tickets }}</p>
            </div>
            <div class="stat-icon red" style="background: #fee2e2; color: #dc2626; width: 3.5rem; height: 3.5rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.7rem;">
                <i class="fas fa-comment"></i>
            </div>
        </div>
        <div class="stat-card" style="background: #fff; border-radius: 1rem; box-shadow: 0 4px 16px rgba(80,80,120,0.07); padding: 2rem 1.5rem; display: flex; align-items: center; justify-content: space-between;">
            <div>
                <h3 class="stat-title" style="color: #6b7280; font-size: 1rem; font-weight: 500;">إجمالي الطلاب</h3>
                <p class="stat-value" style="font-size: 2.2rem; font-weight: bold; color: #312e81; margin-top: 0.5rem;">{{ total_students }}</p>
            </div>
            <div class="stat-icon" style="background: #e0f7fa; color: #00796b; width: 3.5rem; height: 3.5rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.7rem;">
                <i class="fas fa-users"></i>
            </div>
        </div>
        <div class="stat-card" style="background: #fff; border-radius: 1rem; box-shadow: 0 4px 16px rgba(80,80,120,0.07); padding: 2rem 1.5rem; display: flex; align-items: center; justify-content: space-between;">
            <div>
                <h3 class="stat-title" style="color: #6b7280; font-size: 1rem; font-weight: 500;">الطلاب المصريون</h3>
                <p class="stat-value" style="font-size: 2.2rem; font-weight: bold; color: #312e81; margin-top: 0.5rem;">{{ national_students }}</p>
            </div>
            <div class="stat-icon" style="background: #e8f5e9; color: #2e7d32; width: 3.5rem; height: 3.5rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.7rem;">
                <i class="fas fa-user-graduate"></i>
            </div>
        </div>
        <div class="stat-card" style="background: #fff; border-radius: 1rem; box-shadow: 0 4px 16px rgba(80,80,120,0.07); padding: 2rem 1.5rem; display: flex; align-items: center; justify-content: space-between;">
            <div>
                <h3 class="stat-title" style="color: #6b7280; font-size: 1rem; font-weight: 500;">الطلاب الوافدون</h3>
                <p class="stat-value" style="font-size: 2.2rem; font-weight: bold; color: #312e81; margin-top: 0.5rem;">{{ international_students }}</p>
            </div>
            <div class="stat-icon" style="background: #f3e5f5; color: #6a1b9a; width: 3.5rem; height: 3.5rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.7rem;">
                <i class="fas fa-globe"></i>
            </div>
        </div>
    </div>

    <!-- Dashboard Grid -->
    <div class="dashboard-grid" style="display: grid; grid-template-columns: 2fr 1fr; gap: 2rem;">
        <!-- Recent Applications -->
        <div class="card" style="background: #fff; border-radius: 1rem; box-shadow: 0 4px 16px rgba(80,80,120,0.07); padding: 0;">
            <div class="card-header" style="padding: 1.5rem 1.5rem 1rem 1.5rem; border-bottom: 1px solid #f3f4f6; display: flex; justify-content: space-between; align-items: center;">
                <h3 style="font-size: 1.2rem; font-weight: 600; color: #312e81;">التقديمات الأخيرة</h3>
                <a href="{{ url_for('admin_applications') }}" class="view-all" style="color: #4f46e5; font-size: 0.95rem;">عرض الكل</a>
            </div>
            <div class="table-container" style="padding: 0 1.5rem 1.5rem 1.5rem;">
                <table style="width: 100%; border-collapse: separate; border-spacing: 0; background: #fff; border-radius: 0.75rem; overflow: hidden;">
                    <thead>
                        <tr style="background: #f9fafb;">
                            <th style="padding: 0.75rem 1rem;">ID</th>
                            <th style="padding: 0.75rem 1rem;">الاسم</th>
                            <th style="padding: 0.75rem 1rem;">البرنامج</th>
                            <th style="padding: 0.75rem 1rem;">الحالة</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for app in recent_applications %}
                            <tr style="transition: background 0.2s;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='#fff'">
                                <td style="padding: 0.75rem 1rem;">{{ app.app_id }}</td>
                                <td style="padding: 0.75rem 1rem;">{{ app.user.full_name }}</td>
                                <td style="padding: 0.75rem 1rem;">{{ app.program }}</td>
                                <td style="padding: 0.75rem 1rem;">
                                    {# Color the status badge based on value #}
                                    {% set status = app.status|lower %}
                                    {% if 'مقبول' in status or 'accepted' in status %}
                                        <span class="status-badge green" style="padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.95em; font-weight: 500;">{{ app.status }}</span>
                                    {% elif 'مرفوض' in status or 'rejected' in status %}
                                        <span class="status-badge red" style="padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.95em; font-weight: 500;">{{ app.status }}</span>
                                    {% elif 'مراجعة' in status or 'pending' in status %}
                                        <span class="status-badge yellow" style="padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.95em; font-weight: 500;">{{ app.status }}</span>
                                    {% else %}
                                        <span class="status-badge blue" style="padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.95em; font-weight: 500;">{{ app.status }}</span>
                                    {% endif %}
                                </td>
                            </tr>
                        {% else %}
                            <tr>
                                <td colspan="4" class="text-center" style="padding: 1.5rem; color: #6b7280;">لا توجد طلبات حالية</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Recent Support Tickets -->
        <div class="card" style="background: #fff; border-radius: 1rem; box-shadow: 0 4px 16px rgba(80,80,120,0.07); padding: 0;">
            <div class="card-header" style="padding: 1.5rem 1.5rem 1rem 1.5rem; border-bottom: 1px solid #f3f4f6; display: flex; justify-content: space-between; align-items: center;">
                <h3 style="font-size: 1.2rem; font-weight: 600; color: #312e81;">التذاكر الأخيرة</h3>
                <a href="{{ url_for('admin_tickets') }}" class="view-all" style="color: #4f46e5; font-size: 0.95rem;">عرض الكل</a>
            </div>
            <div class="table-container" style="padding: 0 1.5rem 1.5rem 1.5rem;">
                <table style="width: 100%; border-collapse: separate; border-spacing: 0; background: #fff; border-radius: 0.75rem; overflow: hidden;">
                    <thead>
                        <tr style="background: #f9fafb;">
                            <th style="padding: 0.75rem 1rem;">ID</th>
                            <th style="padding: 0.75rem 1rem;">الموضوع</th>
                            <th style="padding: 0.75rem 1rem;">الحالة</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for ticket in recent_tickets %}
                            <tr style="transition: background 0.2s;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='#fff'">
                                <td style="padding: 0.75rem 1rem;">{{ ticket.ticket_id }}</td>
                                <td style="padding: 0.75rem 1rem;">{{ ticket.subject }}</td>
                                <td style="padding: 0.75rem 1rem;">
                                    <span class="status-badge {{ ticket.status|lower|replace(' ', '-') }}" style="padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.85rem; font-weight: 500;">
                                        {{ ticket.status }}
                                    </span>
                                </td>
                            </tr>
                        {% else %}
                            <tr>
                                <td colspan="3" class="text-center" style="padding: 1.5rem; color: #6b7280;">لا توجد تذاكر حديثة</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Certificates & Top Courses Side by Side -->
    <div class="dashboard-row" style="display: flex; flex-wrap: wrap; gap: 2rem; margin-top: 2rem;">
        <!-- Recent Certificates -->
        <div class="card" style="background: #fff; border-radius: 1rem; box-shadow: 0 4px 16px rgba(80,80,120,0.07); flex: 2 1 0; min-width: 320px;">
            <div class="card-header" style="padding: 1.5rem 1.5rem 1rem 1.5rem; border-bottom: 1px solid #f3f4f6;">
                <h3 style="font-size: 1.2rem; font-weight: 600; color: #312e81;">أحدث طلبات التسجيل</h3>
            </div>
            <div class="card-body" style="padding: 1.5rem;">
                <div class="table-container" style="padding: 0;">
                    <table style="width: 100%; border-collapse: separate; border-spacing: 0; background: #fff; border-radius: 0.75rem; overflow: hidden;">
                        <thead>
                            <tr style="background: #f9fafb;">
                                <th style="padding: 0.75rem 1rem;">اسم الطالب</th>
                                <th style="padding: 0.75rem 1rem;">البرنامج</th>
                                <th style="padding: 0.75rem 1rem;">تاريخ التقديم</th>
                                <th style="padding: 0.75rem 1rem;">الحالة</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for certificate in recent_certificates %}
                                <tr style="transition: background 0.2s;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='#fff'">
                                    <td style="padding: 0.75rem 1rem;">{{ certificate.user.full_name }}</td>
                                    <td style="padding: 0.75rem 1rem;">{{ certificate.type }}</td>
                                    <td style="padding: 0.75rem 1rem;">{{ certificate.request_date|format_date }}</td>
                                    <td style="padding: 0.75rem 1rem;">
                                        {% set status = certificate.status|lower %}
                                        {% if 'مقبول' in status or 'accepted' in status %}
                                            <span class="status-badge green" style="padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.95em; font-weight: 500;">{{ certificate.status }}</span>
                                        {% elif 'مرفوض' in status or 'rejected' in status %}
                                            <span class="status-badge red" style="padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.95em; font-weight: 500;">{{ certificate.status }}</span>
                                        {% elif 'مراجعة' in status or 'pending' in status %}
                                            <span class="status-badge yellow" style="padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.95em; font-weight: 500;">{{ certificate.status }}</span>
                                        {% else %}
                                            <span class="status-badge blue" style="padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.95em; font-weight: 500;">{{ certificate.status }}</span>
                                        {% endif %}
                                    </td>
                                </tr>
                            {% else %}
                                <tr>
                                    <td colspan="4" class="text-center" style="padding: 1.5rem; color: #6b7280;">لا توجد طلبات شهادات حديثة</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Top Courses with Progress Bars -->
        <div class="card" style="flex: 1 1 280px; min-width: 260px; background: #fff; border-radius: 1rem; box-shadow: 0 4px 16px rgba(80,80,120,0.07);">
            <div class="card-header">
                <h3>أكثر 3 مقررات تسجيلاً</h3>
            </div>
            <div class="card-body">
                <!-- Use percentage of total students, not just relative to top course -->
                <ul style="list-style: none; margin: 0; padding: 0;">
                {% for course_title, enroll_count in top_courses %}
                    {% set percent = (enroll_count / (total_students or 1) * 100) | round(0, 'floor') %}
                    <li style="margin-bottom: 1.5rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-weight: 500;">{{ course_title }}</span>
                            <span style="color: #888; font-size: 0.95em;">{{ enroll_count }} طالب</span>
                        </div>
                        <div style="background: #f3f4f6; border-radius: 999px; height: 14px; margin-top: 0.5rem; position: relative;">
                            <div style="background: linear-gradient(90deg, #4f46e5, #556df7); border-radius: 999px; height: 100%; width: {{ percent }}%; transition: width 0.5s;"></div>
                            <span style="position: absolute; left: 10px; top: 0; font-size: 0.8em; color: #312e81; line-height: 14px;">{{ percent }}%</span>
                        </div>
                    </li>
                {% else %}
                    <li>لا توجد بيانات متاحة</li>
                {% endfor %}
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block page_scripts %}

{% endblock %}
